import pandas as pd
import matplotlib.pyplot as plt
import matplotlib.dates as mdates
from pathlib import Path

# --- Configuration: File Names and Analysis Parameters ---
# NOTE: Update this absolute path to where your data files are stored.
DATA_DIRECTORY = Path("C:/Users/peter_bkbowcp/OneDrive/Desktop/Dashboard Project")

GOLD_FILE = DATA_DIRECTORY / "Gold Futures Historical Data.csv"
BTC_FILE  = DATA_DIRECTORY / "Bitcoin Historical Data.csv"

# The number of trading days to use for the correlation calculation (e.g., 60 days = ~3 months)
ROLLING_WINDOW = 60 

CLOSE_CANDIDATES = ["Close", "Adj Close", "Close*", "Price", "Last", "Close/Last"]

# --- Helper functions (Reused for Robust Data Cleaning) ---

def clean_numeric_series(s):
    """
    Cleans a pandas Series by removing common non-numeric characters and converts it to float.
    """
    return (s.astype(str)
              .str.replace('"', '', regex=False)
              .str.replace("'", "", regex=False)
              .str.replace(",", "", regex=False)
              .str.strip()
              .replace("", pd.NA)
              .astype(float)
            )

def load_and_clean(filepath):
    """
    Loads a CSV file, identifies Date and a Close price column, cleans the data,
    and returns a DataFrame with 'Date' and cleaned 'Close' prices.
    """
    if not Path(filepath).exists():
        raise FileNotFoundError(f"File not found: {filepath.name}. Checked location: {filepath.parent}")
    
    df = pd.read_csv(filepath, skip_blank_lines=True)
    df.columns = [c.strip() for c in df.columns]

    date_col = next((c for c in df.columns if c.strip().lower() in ["date", "day", "time"]), None)
    if date_col is None:
        raise ValueError(f"No 'Date' column found in {filepath.name}")
    df["Date"] = pd.to_datetime(df[date_col].astype(str).str.replace('"', '').str.strip(), errors='coerce')
    df = df.rename(columns={date_col: "Date"})

    close_col = next((c for c in df.columns for cand in CLOSE_CANDIDATES if c.strip().lower() == cand.strip().lower()), None)
    if close_col is None:
        numeric_cols = [c for c in df.columns if c != "Date" and df[c].astype(str).str.contains(r'[\d]').any()]
        close_col = numeric_cols[0] if numeric_cols else None
        
    if close_col is None:
        raise ValueError(f"No valid price column found in {filepath.name}")
    
    df["Close"] = clean_numeric_series(df[close_col])
    df = df[["Date", "Close"]].dropna(subset=["Date", "Close"]).sort_values("Date").reset_index(drop=True)
    return df

# --- Main analysis and plotting function ---
def plot_rolling_correlation():
    """
    Loads Gold and BTC data, calculates daily percentage change, and plots 
    the 60-day rolling correlation between them with simplified formatting.
    """
    try:
        # Load data
        gold_df = load_and_clean(GOLD_FILE)
        btc_df  = load_and_clean(BTC_FILE)
    except (FileNotFoundError, ValueError) as e:
        print(f"FATAL ERROR: {e}")
        print("\nACTION REQUIRED: Please ensure your data files exist and the 'DATA_DIRECTORY' path is correct.")
        return

    # 1. Prepare Data & Filter 10 Years
    combined = pd.merge(gold_df, btc_df, on="Date", how="inner", suffixes=("_GOLD", "_BTC"))
    
    # Calculate daily % change 
    combined["GOLD_Change"] = combined["Close_GOLD"].pct_change()
    combined["BTC_Change"]  = combined["Close_BTC"].pct_change()
    combined = combined.dropna(subset=["GOLD_Change", "BTC_Change"])
    
    # Filter for the last 10 years of available common data
    start_date = combined["Date"].max() - pd.DateOffset(years=10)
    combined = combined[combined["Date"] >= start_date]

    if combined.empty:
        print("ERROR: No overlapping data found after filtering for the last 10 years.")
        return

    # 2. Calculate Rolling Correlation
    rolling_corr = combined["GOLD_Change"].rolling(window=ROLLING_WINDOW).corr(combined["BTC_Change"])
    
    # 3. Setup Plot
    plt.style.use('default') 
    fig, ax = plt.subplots(figsize=(16, 8))
    
    # --- EDITED: Removed explicit background color setting and ensuring no gridlines ---
    ax.grid(False)
    # The default style provides a clean background, so explicit setting is removed.
    
    LINE_COLOR = "#005080" # Deep Teal Blue
    
    # 4. Plotting the Correlation Series
    ax.plot(combined["Date"], rolling_corr, 
              label=f"{ROLLING_WINDOW}-Day Rolling Correlation (Gold vs. BTC)", 
              color=LINE_COLOR, 
              linewidth=2.5,
              zorder=5)
    
    # 5. Add Reference Lines (Only Zero Correlation remains)
    
    # Zero Correlation (Crucial Reference)
    ax.axhline(0.0, color='black', linestyle='-', linewidth=1.5, alpha=0.8, zorder=1)
    
    # 6. Final Touches
    
    # Set Y-axis bounds to the theoretical max/min for correlation
    ax.set_ylim(-1.0, 1.0)
    
    # Format X-axis to show years only
    years = mdates.YearLocator()
    years_fmt = mdates.DateFormatter('%Y')
    ax.xaxis.set_major_locator(years)
    ax.xaxis.set_major_formatter(years_fmt)
    plt.xticks(rotation=0) 
    
    ax.set_xlabel("Date", fontsize=12)
    ax.set_ylabel("Correlation Coefficient (Ï)", fontsize=12, fontweight='bold')
    ax.set_title(f"Gold Vs Bitcoin {ROLLING_WINDOW}-Day Rolling Correlation", 
                  fontsize=18, fontweight='bold', pad=20)
    
    ax.legend(loc='lower left', fontsize=11, frameon=True, shadow=True)
    plt.tight_layout()
    plt.show()
    
    print("\n--- Plotting Rolling Correlation Complete ---")
    print(f"Rolling Window Size: {ROLLING_WINDOW} days")
    print(f"Date Range: {combined['Date'].min().strftime('%Y-%m-%d')} to {combined['Date'].max().strftime('%Y-%m-%d')}")
    
if __name__ == "__main__":
    plot_rolling_correlation()

# Comments from Chat GPT
ðŸ§­ Comprehensive Interpretation: 60-Day Rolling Correlation between Gold and Bitcoin (2015-2025)
1. What the chart and statistics show in plain language

This plot measures how Gold and Bitcoin daily returns have moved together (or apart) over a 60-trading-day window â€” roughly three months.
The correlation coefficient (Ï) ranges from âˆ’1 (perfectly opposite moves) to +1 (perfectly in sync).

Your calculated stats:

Metric	Value	Interpretation
Mean correlation	0.0821	On average, Gold and BTC barely move together â€” essentially uncorrelated.
Median correlation	0.0688	The â€œtypicalâ€ short-term relationship is slightly positive but weak.
Maximum correlation	+0.5432 (Sep 2020)	At that point, they moved together fairly strongly â€” moderate positive regime.
Minimum correlation	âˆ’0.3140 (Dec 2023)	Brief episode where they moved in opposite directions â€” modest negative regime.
Period covered	Oct 2015 â€“ Oct 2025	About a decade of overlapping data (2,512 rolling values).
Bottom line:

Over ten years, the average relationship is weak (â‰ˆ 0.08) and often fluctuates around zero.
That confirms what your graph shows visually â€” no stable or structural correlation between Gold and Bitcoin. The relationship drifts through short-lived positive and negative phases.

2. Interpreting the correlation levels
ðŸŸ¦ Most of the time (Ï â‰ˆ 0 â€“ 0.1)

Gold and Bitcoin are statistically independent â€” they donâ€™t predict each other.
This is ideal for diversification: owning both reduces total portfolio variance because they usually donâ€™t move together.

ðŸŸ§ When correlation spikes upward (Ï â†’ +0.5)

Periods like mid-2020 show a moderate positive link â€” both assets rose together.
That window coincides with:

Massive liquidity injections during COVID stimulus,

Inflation hedging narrative driving both â€œhard assetâ€ demand,

BTC rallying alongside gold as investors sought alternatives to fiat.

Here, goldâ€™s safe-haven behavior aligned with bitcoinâ€™s â€œdigital goldâ€ story â€” but this coupling didnâ€™t last.

ðŸŸª When correlation dips (Ï â†’ âˆ’0.3)

Episodes like late 2023 show inverse movement â€” bitcoin rallied while gold stalled, or vice versa.
These negative patches imply risk-rotation: investors moving capital between â€œriskâ€ (BTC) and â€œdefensiveâ€ (gold) assets, depending on macro sentiment.

3. Volatility and sensitivity analysis
âš¡ Bitcoin dominates short-term correlation shifts

Bitcoinâ€™s daily volatility is an order of magnitude higher than goldâ€™s (commonly 50-80% annualized vs. goldâ€™s ~15%).

Because correlation uses normalized returns, BTCâ€™s large moves swing the correlation line far more than goldâ€™s steadier fluctuations.

During market stress or crypto-specific shocks (FTX collapse, regulatory crackdowns, liquidity crunches), the correlation can sharply turn negative as BTC sells off while gold is stable or gains slightly.

ðŸ’¹ Gold is the â€œslow moverâ€

Goldâ€™s price adjusts gradually to macro forces like real yields, inflation, and central-bank demand â€” so its volatility is low and its contribution to correlation swings is minor.
Thus, BTCâ€™s extreme bursts of volatility drive most of the rolling correlation instability.

4. Regime behaviour and macro interpretation
ðŸ”¸ 2015â€“2017: Low, noisy correlation near zero

Bitcoin was tiny, speculative, and detached from macro assets â€” correlation hovered around zero.

ðŸ”¸ 2020â€“2021: Positive regime (peak = 0.54 @ Sep 2020)

Global stimulus, negative real rates, and inflation fears pushed both gold and BTC higher.
Investors treated both as store-of-value hedges. The â€œdigital goldâ€ narrative gained traction.
But as risk appetite surged in late 2020, BTCâ€™s speculative boom outpaced gold â€” correlation drifted back toward zero.

ðŸ”¸ 2022â€“2023: Choppy, mixed signals

Rising rates hurt both assets intermittently, but BTCâ€™s drawdowns (Terra/FTX crises) were idiosyncratic, producing sharp negative correlations as gold remained steady or gained.
Minimum Ï = âˆ’0.314 (Dec 2023) marks such a risk-off period where investors fled BTC but held or rotated into gold.

ðŸ”¸ 2024â€“2025: Mild positive recovery

The tail end shows correlation stabilizing slightly positive again â€” possibly reflecting both reacting to macro factors like rate expectations and inflation trends rather than crypto-specific chaos.

5. Comparison to empirical research

Extensive empirical work supports your observed pattern:

Finding	Supported by research
Gold consistently retains safe-haven status	Studies (Baur & Lucey 2010; Kumar et al. 2022) show gold provides downside protection in crises.
Bitcoin behaves inconsistently	Klein et al. (2018) and Choi et al. (2021) show BTCâ€™s correlations with traditional assets and gold are unstable and regime-dependent.
BTC more sensitive to market volatility	DCC-GARCH and regime-switching analyses confirm BTCâ€™s correlation with other assets spikes during turmoil and falls back afterward.
â€œDigital goldâ€ claim is conditional	Works after 2020 (e.g., Wen et al. 2022) find short bursts of positive correlation driven by inflation narratives, not by intrinsic safe-haven properties.

So your data lines up with the consensus: gold = stable safe haven, BTC = volatility-sensitive speculative asset whose correlation varies with liquidity and risk cycles.

6. Portfolio and practical implications

Average correlation â‰ˆ 0.08 â†’ strong diversification value.
Holding both reduces risk without severely dampening upside potential.

Dynamic rebalancing matters.
During high correlation spikes (> 0.4), gold loses some hedging power; rebalance positions or hedge differently.

Monitor BTC volatility as a leading indicator of correlation swings â€” large BTC variance often precedes correlation shifts.

Donâ€™t rely on BTC as a crisis hedge.
Negative correlation periods exist but are sporadic; gold remains the reliable defensive component.

7. Final synthesis (no sugar-coating)

This ten-year rolling-correlation analysis shows no stable or consistent relationship between gold and bitcoin.
The average correlation is close to zero (0.08) â€” they usually move independently.
Occasional positive surges (like 2020) occur when both respond to macro liquidity or inflation narratives, but these phases are short-lived.
During market volatility or crypto-specific stress, correlation often turns negative, reflecting BTCâ€™s risk-asset nature versus goldâ€™s defensive role.
In short:

Gold remains the classic safe haven; Bitcoin remains a volatile, sentiment-driven asset occasionally mimicking gold but often behaving like high-beta risk capital.
